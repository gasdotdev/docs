# D1 Seeding

## _seed.ts

You can seed D1 resources using the resource's `_seed.ts` file, the Cloudflare plugin's exported `D1Seeder` class, and `@faker-js/faker` in both development and staging environments.

`@gasdotdev/plugin-cloudflare/d1-seeder`:
1. Starts a disposable D1 instance locally.
2. Runs all [migrations](./d1-migrations.md) located in the D1 resource's `./migrations` directory against the disposable D1 instance.
3. Exposes the disposable D1 instance for inserting seed data.
4. Exports all table data from the disposable D1 instance to a `.gas/seed-export.sql` file in the D1 resource's directory.
5. Stops the disposable D1 instance.

What happens next depends on the environment.

```ts
import { D1Seeder } from '@gasdotdev/plugin-cloudflare/d1-seeder';
import { rootDb } from '../func.ts';
import { faker } from '@faker-js/faker';
import { createAuthor } from './author.ts';
import { createBook } from './book.ts';

export async function seed() {
	// Keep data consistent across seeds
	faker.seed(123);

	const d1Seeder = new D1Seeder({
		resourceName: rootDb.name,
	});

	await d1Seeder.start();

	const db = d1Seeder.instance();

	console.log('running seeder');

	const authorIds: string[] = [];

	console.log('creating authors...');

	for (let i = 0; i < 10; i++) {
		const result = await createAuthor({
			db,
			author: {
				name: faker.person.fullName(),
			},
		});
		if (result.ok) authorIds.push(result.val.id);
	}

	console.log('creating books...');

	for (let i = 0; i < 50; i++) {
		await createBook({
			db,
			book: {
				authorId: faker.helpers.arrayElement(authorIds),
				title: faker.lorem.words({ min: 2, max: 5 }),
			},
		});
	}

	await d1Seeder.stop();

	console.log('ran seeder');
}

(async () => {
	try {
		await seed();
	} catch (error) {
		console.error('Unable to seed database:', error);
		process.exit(1);
	}
})();
```

## Seeding in Development

In the development environment, the Cloudflare plugin dev server will read the exported SQL file generated by `_seed.ts` and load it into the resource's active D1 database instance for development.

The Cloudflare plugin dev server also watches `_seeds.ts` and will re-run the process above if the file changes.

## Seeding in Staging

Seeding is handled automatically during staging when a D1 resource's when a D1 resource's `seed` param is set in its `func.ts` and the resource has a `_seed.ts` file.

During deployment, the `seed` param becomes a separate sub-resource (`root-db:seed`) in the dependency graph. That ensures seeds run after the database is created but before Workers that depend on it.

When `onChange` files have changed since the last deployment, the deployment runs `npm run seed --workspace={resourceName}` which executes `_seed.ts` via the D1 resource's `package.json` `seed` script.

In this example, seeding will occur during `preview` stage deployments whenever migration or source files have changed. Other stage deployments, like production, will skip seeding entirely.

`./gas/db/func.ts`:

```ts
import { defineCfD1 } from '@gasdotdev/plugin-cloudflare/definitions';

export const rootDb = (() => {
	return defineCfD1({
		name: 'root-db',
		migrate:
			process.env.GAS_STAGE === 'production'
				? {
						onChange: './migrations',
					}
				: undefined,
		seed:
			process.env.GAS_STAGE === 'preview'
				? {
						onChange: ['./migrations', './src/**/*.ts'],
					}
				: undefined,
	} as const);
})();
```
